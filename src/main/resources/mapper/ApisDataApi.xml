<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.scheduler.mapper.ApisDataMapper">
    <select id="countAptTrades" parameterType="com.example.scheduler.dto.BusCityInfoDto" resultType="int">
        SELECT COUNT(*)
        FROM ai.apt_trades
        WHERE deal_year = #{dealYear}
        AND deal_month = #{dealMonth}
        AND deal_day = #{dealDay}
    </select>
    <select id="selectApisBusCityInfo" resultType="com.example.scheduler.dto.BusCityInfoDto">
        select
            seq                                         as seq,
            city_code::text                             as cityCode,   -- dto가 string이면 ::text
            city_name                                   as cityName,
            to_char(reg_dt, 'yyyy-mm-dd hh24:mi:ss')    as regDt       -- dto가 string이면 ok
            from map.bus_city_info
    </select>
    <insert id="insertApisBusCityInfo" parameterType="com.example.scheduler.dto.BusCityInfoDto">
        INSERT INTO map.bus_city_info (city_code, city_name)
        VALUES
        <foreach collection="list" item="i" separator=",">
            (#{i.cityCode}, #{i.cityName})
        </foreach>
        ON CONFLICT (city_code, city_name) DO NOTHING
    </insert>
    <select id="insertApisBusRouteInfo" parameterType="map" resultType="string">
        INSERT INTO map.bus_route_info
        (route_id, route_no, route_tp, start_node_nm, end_node_nm, start_vehicle_time, end_vehicle_time, city_code, city_name)
        VALUES
        <foreach collection="list" item="i" separator=",">
            (#{i.routeId}, #{i.routeNo}, #{i.routeTp}, #{i.startNodeNm}, #{i.endNodeNm},
            #{i.startVehicleTime}, #{i.endVehicleTime},#{i.cityCode}, #{i.cityName})
        </foreach>
        ON CONFLICT (route_id) DO NOTHING
        RETURNING route_id
    </select>
    <select id="insertApisBusStopInfo" parameterType="map" resultType="string">
        INSERT INTO map.bus_stop_info
        (
            city_mgmt_name, city_name, city_code, mobile_short_no,
            stop_name, stop_code, lon, lat, collected_on)
            SELECT
            t.city_mgmt_name, t.city_name, t.city_code, t.mobile_short_no,
            t.stop_name, t.stop_code,
            -- 입력은 4326 → 저장은 3857(x/y)
            ST_X(ST_Transform(ST_SetSRID(ST_MakePoint(t.lon, t.lat), 4326), 3857)) AS lon,
            ST_Y(ST_Transform(ST_SetSRID(ST_MakePoint(t.lon, t.lat), 4326), 3857)) AS lat,
            t.collected_on
        FROM (
            VALUES
            <foreach collection="list" item="i" separator=",">
                (#{i.cityMgmtName},
                #{i.cityName},
                #{i.cityCode},
                #{i.mobileShortNo},
                #{i.stopName},
                #{i.stopCode},
                #{i.lon},
                #{i.lat},
                #{i.collectedOn})
            </foreach>
        ) AS t(city_mgmt_name, city_name, city_code, mobile_short_no,
        stop_name, stop_code, lon, lat, collected_on)
        WHERE t.lon BETWEEN -180 AND 180
        AND t.lat BETWEEN -85.05112878 AND 85.05112878
        ON CONFLICT (stop_code) DO NOTHING
        RETURNING stop_code
    </select>
    <select id="insertApisBusStopInfoGeoJson">
        CREATE OR REPLACE VIEW "map".v_bus_stop_info_geojson
        AS WITH dedup AS (
            SELECT DISTINCT ON (bus_stop_info.lon, bus_stop_info.lat) bus_stop_info.id,
            bus_stop_info.city_mgmt_name,
            bus_stop_info.city_name,
            bus_stop_info.city_code,
            bus_stop_info.stop_name,
            bus_stop_info.stop_code,
            bus_stop_info.lon,
            bus_stop_info.lat,
            bus_stop_info.collected_on,
            bus_stop_info.geom
            FROM map.bus_stop_info
            WHERE bus_stop_info.geom IS NOT NULL
            ORDER BY bus_stop_info.lon, bus_stop_info.lat, bus_stop_info.id DESC
        ), feat AS (
            SELECT json_build_object('type', 'Feature', 'id', 'map:bus_stop_info.'::text || dedup.id::text, 'geometry', st_asgeojson(dedup.geom)::json, 'properties', json_build_object('city_mgmt_name', dedup.city_mgmt_name, 'city_name', dedup.city_name, 'city_code', dedup.city_code, 'stop_name', dedup.stop_name, 'stop_code', dedup.stop_code, 'lon', dedup.lon,'lat', dedup.lat,'collected_on',dedup.collected_on)) AS feature
            FROM dedup
        )
        SELECT json_build_object('type', 'FeatureCollection', 'features', COALESCE(json_agg(feature), '[]'::json)) AS geojson
        FROM feat
    </select>
    <select id="insertPharmacy" parameterType="map" resultType="string">
        INSERT INTO map.pharmacy
        (
        hpid, duty_name, duty_addr, duty_tel1, duty_fax,
        duty_time1s, duty_time1c, duty_time2s, duty_time2c,
        duty_time3s, duty_time3c, duty_time4s, duty_time4c,
        duty_time5s, duty_time5c, duty_time6s, duty_time6c,
        wgs84_lon, wgs84_lat, geom, post_cdn1, post_cdn2, rnum, collected_on
        )
        SELECT
        t.hpid, t.duty_name, t.duty_addr, t.duty_tel1, t.duty_fax,
        t.duty_time1s, t.duty_time1c, t.duty_time2s, t.duty_time2c,
        t.duty_time3s, t.duty_time3c, t.duty_time4s, t.duty_time4c,
        t.duty_time5s, t.duty_time5c, t.duty_time6s, t.duty_time6c,
        ST_X(ST_Transform(ST_SetSRID(ST_MakePoint(t.wgs84_lon, t.wgs84_lat), 4326), 3857)) AS wgs84_lon,
        ST_Y(ST_Transform(ST_SetSRID(ST_MakePoint(t.wgs84_lon, t.wgs84_lat), 4326), 3857)) AS wgs84_lat,
        ST_SetSRID(ST_MakePoint(
        ST_X(ST_Transform(ST_SetSRID(ST_MakePoint(t.wgs84_lon, t.wgs84_lat), 4326), 3857)),
        ST_Y(ST_Transform(ST_SetSRID(ST_MakePoint(t.wgs84_lon, t.wgs84_lat), 4326), 3857))
        ), 3857) AS geom,
        t.post_cdn1, t.post_cdn2, t.rnum,
        CASE
        WHEN t.collected_on IS NULL THEN CURRENT_DATE
        ELSE t.collected_on::DATE
        END AS collected_on
        FROM (
        VALUES
        <foreach collection="list" item="i" separator=",">
            (#{i.hpid},
            #{i.dutyName},
            #{i.dutyAddr},
            #{i.dutyTel1},
            #{i.dutyFax},
            #{i.dutyTime1s},
            #{i.dutyTime1c},
            #{i.dutyTime2s},
            #{i.dutyTime2c},
            #{i.dutyTime3s},
            #{i.dutyTime3c},
            #{i.dutyTime4s},
            #{i.dutyTime4c},
            #{i.dutyTime5s},
            #{i.dutyTime5c},
            #{i.dutyTime6s},
            #{i.dutyTime6c},
            #{i.wgs84Lon},
            #{i.wgs84Lat},
            #{i.postCdn1},
            #{i.postCdn2},
            #{i.rnum},
            #{i.collectedOn})
        </foreach>
        ) AS t(hpid, duty_name, duty_addr, duty_tel1, duty_fax,
        duty_time1s, duty_time1c, duty_time2s, duty_time2c,
        duty_time3s, duty_time3c, duty_time4s, duty_time4c,
        duty_time5s, duty_time5c, duty_time6s, duty_time6c,
        wgs84_lon, wgs84_lat, post_cdn1, post_cdn2, rnum, collected_on)
        WHERE t.wgs84_lon BETWEEN -180 AND 180
        AND t.wgs84_lat BETWEEN -85.05112878 AND 85.05112878
        AND t.hpid IS NOT NULL
        ON CONFLICT (hpid) DO NOTHING
        RETURNING hpid
    </select>
    <select id="insertApisPharmacyInfoGeoJson">
        CREATE OR REPLACE VIEW "map".v_pharmacy_info_geojson
        AS WITH dedup AS (
        SELECT DISTINCT ON (pharmacy.wgs84_lon, pharmacy.wgs84_lat)
        pharmacy.id,
        pharmacy.hpid,
        pharmacy.duty_name,
        pharmacy.duty_addr,
        pharmacy.duty_tel1,
        pharmacy.duty_fax,
        pharmacy.duty_time1s,
        pharmacy.duty_time1c,
        pharmacy.duty_time2s,
        pharmacy.duty_time2c,
        pharmacy.duty_time3s,
        pharmacy.duty_time3c,
        pharmacy.duty_time4s,
        pharmacy.duty_time4c,
        pharmacy.duty_time5s,
        pharmacy.duty_time5c,
        pharmacy.duty_time6s,
        pharmacy.duty_time6c,
        pharmacy.wgs84_lon,
        pharmacy.wgs84_lat,
        pharmacy.post_cdn1,
        pharmacy.post_cdn2,
        pharmacy.collected_on,
        pharmacy.geom AS geom
        FROM map.pharmacy
        WHERE pharmacy.geom IS NOT NULL
        ORDER BY pharmacy.wgs84_lon, pharmacy.wgs84_lat, pharmacy.id DESC
        ), feat AS (
        SELECT json_build_object(
        'type', 'Feature',
        'id', 'map:pharmacy.'::text || dedup.id::text,
        'geometry', st_asgeojson(dedup.geom)::json,
        'properties', json_build_object(
        'hpid', dedup.hpid,
        'duty_name', dedup.duty_name,
        'duty_addr', dedup.duty_addr,
        'duty_tel1', dedup.duty_tel1,
        'duty_fax', dedup.duty_fax,
        'duty_time1s', dedup.duty_time1s,
        'duty_time1c', dedup.duty_time1c,
        'duty_time2s', dedup.duty_time2s,
        'duty_time2c', dedup.duty_time2c,
        'duty_time3s', dedup.duty_time3s,
        'duty_time3c', dedup.duty_time3c,
        'duty_time4s', dedup.duty_time4s,
        'duty_time4c', dedup.duty_time4c,
        'duty_time5s', dedup.duty_time5s,
        'duty_time5c', dedup.duty_time5c,
        'duty_time6s', dedup.duty_time6s,
        'duty_time6c', dedup.duty_time6c,
        'wgs84_lon', dedup.wgs84_lon,
        'wgs84_lat', dedup.wgs84_lat,
        'post_cdn1', dedup.post_cdn1,
        'post_cdn2', dedup.post_cdn2,
        'collected_on', dedup.collected_on
        )
        ) AS feature
        FROM dedup
        )
        SELECT json_build_object(
        'type', 'FeatureCollection',
        'features', COALESCE(json_agg(feature), '[]'::json)
        ) AS geojson
        FROM feat
    </select>
    <select id="insertHospital" parameterType="map" resultType="string">
        INSERT INTO map.hospital
        (
        hpid, duty_name, duty_addr, duty_tel1,
        duty_div, duty_div_nam, duty_emcls, duty_emcls_name, duty_eryn,
        duty_time1s, duty_time1c, duty_time2s, duty_time2c,
        duty_time3s, duty_time3c, duty_time4s, duty_time4c,
        duty_time5s, duty_time5c, duty_time6s, duty_time6c,
        duty_time7s, duty_time7c,
        wgs84_lon, wgs84_lat, geom, post_cdn1, post_cdn2, rnum, collected_on
        )
        SELECT
        t.hpid, t.duty_name, t.duty_addr, t.duty_tel1,
        t.duty_div, t.duty_div_nam, t.duty_emcls, t.duty_emcls_name, t.duty_eryn,
        t.duty_time1s, t.duty_time1c, t.duty_time2s, t.duty_time2c,
        t.duty_time3s, t.duty_time3c, t.duty_time4s, t.duty_time4c,
        t.duty_time5s, t.duty_time5c, t.duty_time6s, t.duty_time6c,
        t.duty_time7s, t.duty_time7c,
        ST_X(ST_Transform(ST_SetSRID(ST_MakePoint(t.wgs84_lon, t.wgs84_lat), 4326), 3857)) AS wgs84_lon,
        ST_Y(ST_Transform(ST_SetSRID(ST_MakePoint(t.wgs84_lon, t.wgs84_lat), 4326), 3857)) AS wgs84_lat,
        ST_SetSRID(ST_MakePoint(
        ST_X(ST_Transform(ST_SetSRID(ST_MakePoint(t.wgs84_lon, t.wgs84_lat), 4326), 3857)),
        ST_Y(ST_Transform(ST_SetSRID(ST_MakePoint(t.wgs84_lon, t.wgs84_lat), 4326), 3857))
        ), 3857) AS geom,
        t.post_cdn1, t.post_cdn2, t.rnum,
        CASE
        WHEN t.collected_on IS NULL THEN CURRENT_DATE
        ELSE t.collected_on::DATE
        END AS collected_on
        FROM (
        VALUES
        <foreach collection="list" item="i" separator=",">
            (#{i.hpid},
            #{i.dutyName},
            #{i.dutyAddr},
            #{i.dutyTel1},
            #{i.dutyDiv},
            #{i.dutyDivNam},
            #{i.dutyEmcls},
            #{i.dutyEmclsName},
            #{i.dutyEryn},
            #{i.dutyTime1s},
            #{i.dutyTime1c},
            #{i.dutyTime2s},
            #{i.dutyTime2c},
            #{i.dutyTime3s},
            #{i.dutyTime3c},
            #{i.dutyTime4s},
            #{i.dutyTime4c},
            #{i.dutyTime5s},
            #{i.dutyTime5c},
            #{i.dutyTime6s},
            #{i.dutyTime6c},
            #{i.dutyTime7s},
            #{i.dutyTime7c},
            #{i.wgs84Lon},
            #{i.wgs84Lat},
            #{i.postCdn1},
            #{i.postCdn2},
            #{i.rnum},
            #{i.collectedOn})
        </foreach>
        ) AS t(hpid, duty_name, duty_addr, duty_tel1,
        duty_div, duty_div_nam, duty_emcls, duty_emcls_name, duty_eryn,
        duty_time1s, duty_time1c, duty_time2s, duty_time2c,
        duty_time3s, duty_time3c, duty_time4s, duty_time4c,
        duty_time5s, duty_time5c, duty_time6s, duty_time6c,
        duty_time7s, duty_time7c,
        wgs84_lon, wgs84_lat, post_cdn1, post_cdn2, rnum, collected_on)
        WHERE t.wgs84_lon BETWEEN -180 AND 180
        AND t.wgs84_lat BETWEEN -85.05112878 AND 85.05112878
        AND t.hpid IS NOT NULL
        ON CONFLICT (hpid) DO NOTHING
        RETURNING hpid
    </select>
    <select id="insertApisHospitalInfoGeoJson">
        CREATE OR REPLACE VIEW "map".v_hospital_info_geojson
        AS WITH dedup AS (
        SELECT DISTINCT ON (hospital.wgs84_lon, hospital.wgs84_lat)
        hospital.id,
        hospital.hpid,
        hospital.duty_name,
        hospital.duty_addr,
        hospital.duty_tel1,
        hospital.duty_div,
        hospital.duty_div_nam,
        hospital.duty_emcls,
        hospital.duty_emcls_name,
        hospital.duty_eryn,
        hospital.duty_time1s,
        hospital.duty_time1c,
        hospital.duty_time2s,
        hospital.duty_time2c,
        hospital.duty_time3s,
        hospital.duty_time3c,
        hospital.duty_time4s,
        hospital.duty_time4c,
        hospital.duty_time5s,
        hospital.duty_time5c,
        hospital.duty_time6s,
        hospital.duty_time6c,
        hospital.duty_time7s,
        hospital.duty_time7c,
        hospital.wgs84_lon,
        hospital.wgs84_lat,
        hospital.post_cdn1,
        hospital.post_cdn2,
        hospital.collected_on,
        hospital.geom AS geom
        FROM map.hospital
        WHERE hospital.geom IS NOT NULL
        ORDER BY hospital.wgs84_lon, hospital.wgs84_lat, hospital.id DESC
        ), feat AS (
        SELECT json_build_object(
        'type', 'Feature',
        'id', 'map:hospital.'::text || dedup.id::text,
        'geometry', st_asgeojson(dedup.geom)::json,
        'properties', json_build_object(
        'hpid', dedup.hpid,
        'duty_name', dedup.duty_name,
        'duty_addr', dedup.duty_addr,
        'duty_tel1', dedup.duty_tel1,
        'duty_div', dedup.duty_div,
        'duty_div_nam', dedup.duty_div_nam,
        'duty_emcls', dedup.duty_emcls,
        'duty_emcls_name', dedup.duty_emcls_name,
        'duty_eryn', dedup.duty_eryn,
        'duty_time1s', dedup.duty_time1s,
        'duty_time1c', dedup.duty_time1c,
        'duty_time2s', dedup.duty_time2s,
        'duty_time2c', dedup.duty_time2c,
        'duty_time3s', dedup.duty_time3s,
        'duty_time3c', dedup.duty_time3c,
        'duty_time4s', dedup.duty_time4s,
        'duty_time4c', dedup.duty_time4c,
        'duty_time5s', dedup.duty_time5s,
        'duty_time5c', dedup.duty_time5c,
        'duty_time6s', dedup.duty_time6s,
        'duty_time6c', dedup.duty_time6c,
        'duty_time7s', dedup.duty_time7s,
        'duty_time7c', dedup.duty_time7c,
        'wgs84_lon', dedup.wgs84_lon,
        'wgs84_lat', dedup.wgs84_lat,
        'post_cdn1', dedup.post_cdn1,
        'post_cdn2', dedup.post_cdn2,
        'collected_on', dedup.collected_on
        )
        ) AS feature
        FROM dedup
        )
        SELECT json_build_object(
        'type', 'FeatureCollection',
        'features', COALESCE(json_agg(feature), '[]'::json)
        ) AS geojson
        FROM feat
    </select>
    <select id="insertAptTrades" parameterType="java.util.List" resultType="string">
        INSERT INTO ai.apt_trades (
        sgg_cd, umd_cd, land_cd, bonbun, bubun, jibun,
        umd_nm, road_nm, road_nm_sgg_cd, road_nm_cd, road_nm_seq,
        road_nmb_cd, road_nm_bonbun, road_nm_bubun,
        apt_nm, apt_dong, apt_seq,
        build_year, exclu_use_ar, floor,
        deal_year, deal_month, deal_day, deal_amount,
        dealing_gbn, cdeal_type, cdeal_day, estate_agent_sgg_nm,
        sler_gbn, buyer_gbn, rgst_date, land_leasehold_gbn,
        created_at
        )
        SELECT
        t.sgg_cd, t.umd_cd, t.land_cd, t.bonbun, t.bubun, t.jibun,
        t.umd_nm, t.road_nm, t.road_nm_sgg_cd, t.road_nm_cd, t.road_nm_seq,
        t.road_nmb_cd, t.road_nm_bonbun, t.road_nm_bubun,
        t.apt_nm, t.apt_dong, t.apt_seq,
        t.build_year::integer,
        t.exclu_use_ar::numeric,
        t.floor::integer,
        t.deal_year::integer,
        t.deal_month::integer,
        t.deal_day::integer,
        t.deal_amount::bigint,
        t.dealing_gbn, t.cdeal_type, t.cdeal_day, t.estate_agent_sgg_nm,
        t.sler_gbn, t.buyer_gbn, t.rgst_date, t.land_leasehold_gbn,
        CASE
        WHEN t.created_at IS NULL THEN NOW()
        ELSE t.created_at::timestamp
        END
        FROM (
        VALUES
        <foreach collection="list" item="i" separator=",">
            (
            #{i.sggCd}, #{i.umdCd}, #{i.landCd}, #{i.bonbun}, #{i.bubun}, #{i.jibun},
            #{i.umdNm}, #{i.roadNm}, #{i.roadNmSggCd}, #{i.roadNmCd}, #{i.roadNmSeq},
            #{i.roadNmbCd}, #{i.roadNmBonbun}, #{i.roadNmBubun},
            #{i.aptNm}, #{i.aptDong}, #{i.aptSeq},
            #{i.buildYear}, #{i.excluUseAr}, #{i.floor},
            #{i.dealYear}, #{i.dealMonth}, #{i.dealDay}, #{i.dealAmount},
            #{i.dealingGbn}, #{i.cdealType}, #{i.cdealDay}, #{i.estateAgentSggNm},
            #{i.slerGbn}, #{i.buyerGbn}, #{i.rgstDate}, #{i.landLeaseholdGbn},
            #{i.createdAt}
            )
        </foreach>
        ) AS t(
        sgg_cd, umd_cd, land_cd, bonbun, bubun, jibun,
        umd_nm, road_nm, road_nm_sgg_cd, road_nm_cd, road_nm_seq,
        road_nmb_cd, road_nm_bonbun, road_nm_bubun,
        apt_nm, apt_dong, apt_seq,
        build_year, exclu_use_ar, floor,
        deal_year, deal_month, deal_day, deal_amount,
        dealing_gbn, cdeal_type, cdeal_day, estate_agent_sgg_nm,
        sler_gbn, buyer_gbn, rgst_date, land_leasehold_gbn,
        created_at
        )
        RETURNING id::text
    </select>
</mapper>
